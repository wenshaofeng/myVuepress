# git 数据恢复

记住，任何已经提交到 Git 的都可以被恢复。即便在已经删除的分支中的提交，或者用 --amend 重新改写的提交，都可以被恢复（关于数据恢复的内容见第九章）。所以，你可能失去的数据，仅限于没有提交过的，对 Git 来说它们就像从未存在过一样。

## 清理
Git 会保留从项目最开始保留所有的数据，当一个代码仓库长期使用后，会发现代码仓库越来越大，分支也越来越多；这些都会影响到我们 Git 仓库的速度，如果发现一些分支不需要了，我们可以手动删除，以此提高响应速度；
一般两类分支可能需要清理：

1. 本地不存在，远程存在该分支，但不需要了
2. 远程不存在，本地存在该分支，也不需要了

- 清理远程
```
git push origin --delete <远程分支名>
```
- 清理本地

### 忽略已加入版本控制器的文件和文件夹

有的时候，可能一不小心把某一个原本应该忽略的目录提交到了版本控制器中，再使用 .gitignore 文件去忽略的时候，发现无论如何都无法再次将其忽略，只好默默忍受；这是因为 git 已经索引了该文件而导致的

- 问题复现
>1. 创建了一个本想忽略的文件a，提交到了版本库 
>2. 在.gitignore 设置规则忽略后，发现不生效

- 解决
```bash
// 忽略文件
git rm --cached <文件名>

// 忽略文件夹

//删除该文件夹的缓存
git rm -r --cached test3/
// 强制添加
git add -f test3
```
忽略已存在的文件夹最后一步需要使用 -f 进行强制添加，否则会提示操作失败

## 恢复

### `git reflog` 
一般情况下，除非手动执行了 `git gc` 命令，否则 gc 对那些无用的 object 会保留很长时间后才清除的，`reflog` 是 Git 提供的一个内部工具，用于记录对 Git 仓库进行的各种操作，可以使用 `git reflog show` 所有的管理类操作日志。

- 回滚 reset 操作
不小心用 `git reset` 回滚了提交记录，想找回之前的提交记录: git reflog 查看操作历史，找到执行 git reset 命令之前 commitid，然后 git reset --hard 到那个 commitid 即可。

- 从历史版本中找回删除的文件

有时候，我们在某个版本中删除了文件，后来又突然发现需要这个文件，也是可以恢复的；恢复之前首先确定要恢复的文件在哪一个版本（commit）中，假设那个版本号是： 7a4312sd，文件路径为 abc.php 那么参考命如下：
```
git checkout 7a4312sd abc.php
```

### `git reset`

1. 之前的修改进行了 `commit` 提交，也就是说我们回退前的修改（曾经）存在于版本里;
2. 之前的修改未进行 `commit` 提交，但是进行了 `git add `操作；
3. 之前的修改未进行 `commit` 提交，也未进行`git add`操作。

```shell
// 第一种

## 拿到之前修改的commit的哈希值（或者说id）
git reflog 
git reset --hard [hash]

// 第二种

## 添加到缓存之后进行了reset操作， 此时因为没有进行git commit操作所以没有hash值，
git fsck --lost-found

// 第三种
暂无
```
#### git reset 参数
git reset 分为三种：软 --soft，中 ---mixed，硬 --hard 对应着三种回滚的程度，程度越硬，回滚的越“狠” 

>1. --soft 已 add，但尚未 commit
>2. --mixed（git reset 的默认设定，可以省略不写），文件会回退到未 add（未暂存）的状态 
>3. --hard 硬核，彻底，会彻底返回到回退前的版本状态，了无痕迹

### `git revert` 单独回滚代码：记录不变只回滚代码
```
git revert <要回滚的commit的hash>
```
>需要注意的是，在使用 `revert` 去恢复某个版本代码时，Git 只会撤销指定版本的代码，而不是指定版本后的所有版本。比如说你提交了 1、2、3 三个版本，当你撤销版本 2 的时候，会生成版本 4，但是不会对版本 3 产生影响。

1. `git reset` 命令会改变之前的版本记录，可能会导致不能提交到远程仓库（设置了权限之类的）；
2. `git revert` 命令只会撤销某个版本的代码，然后在当前分支增加一条版本新记录；
3. `git revert` 只会撤销指定版本的代码，而不是指定版本后的所有版本。
