<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>性能工具 - 实际代码优化 | Person Blog</title>
    <meta name="description" content="废柴阿蔚的个人站点">
    <meta name="generator" content="VuePress 1.4.0">
    <link rel="icon" href="/myVuepress/icon.png">
    
    <link rel="preload" href="/myVuepress/assets/css/0.styles.179f8242.css" as="style"><link rel="preload" href="/myVuepress/assets/js/app.9affc5a9.js" as="script"><link rel="preload" href="/myVuepress/assets/js/2.f8270d47.js" as="script"><link rel="preload" href="/myVuepress/assets/js/46.bfec08f7.js" as="script"><link rel="prefetch" href="/myVuepress/assets/js/10.7cc7d6e5.js"><link rel="prefetch" href="/myVuepress/assets/js/11.a8ac10fd.js"><link rel="prefetch" href="/myVuepress/assets/js/12.97293f8a.js"><link rel="prefetch" href="/myVuepress/assets/js/13.0fcd3896.js"><link rel="prefetch" href="/myVuepress/assets/js/14.ef03bf45.js"><link rel="prefetch" href="/myVuepress/assets/js/15.cdf889e2.js"><link rel="prefetch" href="/myVuepress/assets/js/16.65dc8ac3.js"><link rel="prefetch" href="/myVuepress/assets/js/17.f80406a6.js"><link rel="prefetch" href="/myVuepress/assets/js/18.4c78c05d.js"><link rel="prefetch" href="/myVuepress/assets/js/19.c99892e6.js"><link rel="prefetch" href="/myVuepress/assets/js/20.7bc10cd4.js"><link rel="prefetch" href="/myVuepress/assets/js/21.da987efb.js"><link rel="prefetch" href="/myVuepress/assets/js/22.7f27ed16.js"><link rel="prefetch" href="/myVuepress/assets/js/23.03e52dc3.js"><link rel="prefetch" href="/myVuepress/assets/js/24.a1044a31.js"><link rel="prefetch" href="/myVuepress/assets/js/25.2c1992a2.js"><link rel="prefetch" href="/myVuepress/assets/js/26.aa8cb714.js"><link rel="prefetch" href="/myVuepress/assets/js/27.3e7f44d9.js"><link rel="prefetch" href="/myVuepress/assets/js/28.1272e8bb.js"><link rel="prefetch" href="/myVuepress/assets/js/29.0dfaa0e2.js"><link rel="prefetch" href="/myVuepress/assets/js/3.619e3deb.js"><link rel="prefetch" href="/myVuepress/assets/js/30.2871f184.js"><link rel="prefetch" href="/myVuepress/assets/js/31.b067a343.js"><link rel="prefetch" href="/myVuepress/assets/js/32.788def14.js"><link rel="prefetch" href="/myVuepress/assets/js/33.ac1c172b.js"><link rel="prefetch" href="/myVuepress/assets/js/34.e4fcb805.js"><link rel="prefetch" href="/myVuepress/assets/js/35.283fd3a4.js"><link rel="prefetch" href="/myVuepress/assets/js/36.4f4b6b96.js"><link rel="prefetch" href="/myVuepress/assets/js/37.2ad18478.js"><link rel="prefetch" href="/myVuepress/assets/js/38.d07251f1.js"><link rel="prefetch" href="/myVuepress/assets/js/39.1f4032f5.js"><link rel="prefetch" href="/myVuepress/assets/js/4.0435c713.js"><link rel="prefetch" href="/myVuepress/assets/js/40.421032fc.js"><link rel="prefetch" href="/myVuepress/assets/js/41.54f8af4c.js"><link rel="prefetch" href="/myVuepress/assets/js/42.6c8967ce.js"><link rel="prefetch" href="/myVuepress/assets/js/43.699fe672.js"><link rel="prefetch" href="/myVuepress/assets/js/44.d3aaecd1.js"><link rel="prefetch" href="/myVuepress/assets/js/45.9b1fba45.js"><link rel="prefetch" href="/myVuepress/assets/js/47.c6512b42.js"><link rel="prefetch" href="/myVuepress/assets/js/48.7aefb4e5.js"><link rel="prefetch" href="/myVuepress/assets/js/49.854d2c9e.js"><link rel="prefetch" href="/myVuepress/assets/js/5.558222ec.js"><link rel="prefetch" href="/myVuepress/assets/js/50.044ef724.js"><link rel="prefetch" href="/myVuepress/assets/js/51.f4896457.js"><link rel="prefetch" href="/myVuepress/assets/js/52.a3c6b05c.js"><link rel="prefetch" href="/myVuepress/assets/js/53.36d4be9a.js"><link rel="prefetch" href="/myVuepress/assets/js/54.ce514ae7.js"><link rel="prefetch" href="/myVuepress/assets/js/55.fd14391e.js"><link rel="prefetch" href="/myVuepress/assets/js/56.ca152f03.js"><link rel="prefetch" href="/myVuepress/assets/js/57.595856d4.js"><link rel="prefetch" href="/myVuepress/assets/js/58.0cab6c65.js"><link rel="prefetch" href="/myVuepress/assets/js/59.3cf9da10.js"><link rel="prefetch" href="/myVuepress/assets/js/6.d20b0c6e.js"><link rel="prefetch" href="/myVuepress/assets/js/60.36fc6ac2.js"><link rel="prefetch" href="/myVuepress/assets/js/61.a2a9e844.js"><link rel="prefetch" href="/myVuepress/assets/js/62.8a4c0f53.js"><link rel="prefetch" href="/myVuepress/assets/js/63.b5f86849.js"><link rel="prefetch" href="/myVuepress/assets/js/64.9c529920.js"><link rel="prefetch" href="/myVuepress/assets/js/65.c1ba8261.js"><link rel="prefetch" href="/myVuepress/assets/js/66.52273d6b.js"><link rel="prefetch" href="/myVuepress/assets/js/67.81fd65e0.js"><link rel="prefetch" href="/myVuepress/assets/js/68.fd487924.js"><link rel="prefetch" href="/myVuepress/assets/js/69.576833e1.js"><link rel="prefetch" href="/myVuepress/assets/js/7.54cc5d55.js"><link rel="prefetch" href="/myVuepress/assets/js/70.321b474f.js"><link rel="prefetch" href="/myVuepress/assets/js/71.3424a716.js"><link rel="prefetch" href="/myVuepress/assets/js/72.08e5215c.js"><link rel="prefetch" href="/myVuepress/assets/js/73.48e08255.js"><link rel="prefetch" href="/myVuepress/assets/js/74.4526050e.js"><link rel="prefetch" href="/myVuepress/assets/js/75.6cab4ab2.js"><link rel="prefetch" href="/myVuepress/assets/js/76.ab3887de.js"><link rel="prefetch" href="/myVuepress/assets/js/77.88bb657d.js"><link rel="prefetch" href="/myVuepress/assets/js/78.e9b13ff0.js"><link rel="prefetch" href="/myVuepress/assets/js/79.30cff021.js"><link rel="prefetch" href="/myVuepress/assets/js/8.9f971d9c.js"><link rel="prefetch" href="/myVuepress/assets/js/80.0c644097.js"><link rel="prefetch" href="/myVuepress/assets/js/81.ceb83770.js"><link rel="prefetch" href="/myVuepress/assets/js/82.ce519f37.js"><link rel="prefetch" href="/myVuepress/assets/js/83.eeb50b18.js"><link rel="prefetch" href="/myVuepress/assets/js/84.7256cf96.js"><link rel="prefetch" href="/myVuepress/assets/js/85.2a165d0a.js"><link rel="prefetch" href="/myVuepress/assets/js/86.61c5f639.js"><link rel="prefetch" href="/myVuepress/assets/js/87.7cd111cd.js"><link rel="prefetch" href="/myVuepress/assets/js/88.ef0f4a42.js"><link rel="prefetch" href="/myVuepress/assets/js/89.77bf2a47.js"><link rel="prefetch" href="/myVuepress/assets/js/9.f3a8670d.js"><link rel="prefetch" href="/myVuepress/assets/js/90.ec2e1f89.js"><link rel="prefetch" href="/myVuepress/assets/js/91.91f2f18a.js"><link rel="prefetch" href="/myVuepress/assets/js/92.589f12ff.js"><link rel="prefetch" href="/myVuepress/assets/js/93.3142ce3f.js"><link rel="prefetch" href="/myVuepress/assets/js/94.9797379b.js"><link rel="prefetch" href="/myVuepress/assets/js/95.52ac67cb.js"><link rel="prefetch" href="/myVuepress/assets/js/96.bdd6565d.js">
    <link rel="stylesheet" href="/myVuepress/assets/css/0.styles.179f8242.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/myVuepress/" class="home-link router-link-active"><img src="/myVuepress/icon.png" alt="Person Blog" class="logo"> <span class="site-name can-hide">Person Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/myVuepress/interview/" class="nav-link">
  前端面试之道
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JavaScript书籍" class="dropdown-title"><span class="title">JavaScript书籍</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myVuepress/jsbooks/es6/" class="nav-link">
  深入理解ES6
</a></li><li class="dropdown-item"><!----> <a href="/myVuepress/jsbooks/renzhe/" class="nav-link">
  javaScript忍者秘籍
</a></li><li class="dropdown-item"><!----> <a href="/myVuepress/jsbooks/you_Dont_Know_JavaScript/" class="nav-link">
  你不知道的JavaScript
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="TS" class="dropdown-title"><span class="title">TS</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myVuepress/jsbooks/typescript_learn/" class="nav-link">
  TypeScript初学
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="node" class="dropdown-title"><span class="title">node</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myVuepress/node/node_BFF/" class="nav-link router-link-active">
  node_BFF
</a></li><li class="dropdown-item"><!----> <a href="/myVuepress/node/node_zhihu/" class="nav-link">
  node_RESTful
</a></li></ul></div></div><div class="nav-item"><a href="/myVuepress/algorithm/" class="nav-link">
  数据结构和算法
</a></div><div class="nav-item"><a href="/myVuepress/vue/" class="nav-link">
  Vue.js
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工程化相关" class="dropdown-title"><span class="title">工程化相关</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myVuepress/webpack/" class="nav-link">
  Webpack基础
</a></li><li class="dropdown-item"><!----> <a href="/myVuepress/git_note/" class="nav-link">
  git 相关
</a></li></ul></div></div><div class="nav-item"><a href="/myVuepress/common/" class="nav-link">
  基础配置功能
</a></div> <a href="https://github.com/#" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/myVuepress/interview/" class="nav-link">
  前端面试之道
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JavaScript书籍" class="dropdown-title"><span class="title">JavaScript书籍</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myVuepress/jsbooks/es6/" class="nav-link">
  深入理解ES6
</a></li><li class="dropdown-item"><!----> <a href="/myVuepress/jsbooks/renzhe/" class="nav-link">
  javaScript忍者秘籍
</a></li><li class="dropdown-item"><!----> <a href="/myVuepress/jsbooks/you_Dont_Know_JavaScript/" class="nav-link">
  你不知道的JavaScript
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="TS" class="dropdown-title"><span class="title">TS</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myVuepress/jsbooks/typescript_learn/" class="nav-link">
  TypeScript初学
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="node" class="dropdown-title"><span class="title">node</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myVuepress/node/node_BFF/" class="nav-link router-link-active">
  node_BFF
</a></li><li class="dropdown-item"><!----> <a href="/myVuepress/node/node_zhihu/" class="nav-link">
  node_RESTful
</a></li></ul></div></div><div class="nav-item"><a href="/myVuepress/algorithm/" class="nav-link">
  数据结构和算法
</a></div><div class="nav-item"><a href="/myVuepress/vue/" class="nav-link">
  Vue.js
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工程化相关" class="dropdown-title"><span class="title">工程化相关</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myVuepress/webpack/" class="nav-link">
  Webpack基础
</a></li><li class="dropdown-item"><!----> <a href="/myVuepress/git_note/" class="nav-link">
  git 相关
</a></li></ul></div></div><div class="nav-item"><a href="/myVuepress/common/" class="nav-link">
  基础配置功能
</a></div> <a href="https://github.com/#" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>技术预研</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>实战演练</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>性能调优篇</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/myVuepress/node/node_BFF/bff_three_optimization_http.html" class="sidebar-link">性能工具 - 性能检测</a></li><li><a href="/myVuepress/node/node_BFF/bff_three_optimization_js.html" class="active sidebar-link">性能工具 - 实际代码优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myVuepress/node/node_BFF/bff_three_optimization_js.html#优化分析" class="sidebar-link">优化分析</a></li><li class="sidebar-sub-header"><a href="/myVuepress/node/node_BFF/bff_three_optimization_js.html#内存管理优化" class="sidebar-link">内存管理优化</a></li><li class="sidebar-sub-header"><a href="/myVuepress/node/node_BFF/bff_three_optimization_js.html#多进程优化" class="sidebar-link">多进程优化</a></li><li class="sidebar-sub-header"><a href="/myVuepress/node/node_BFF/bff_three_optimization_js.html#优化总结" class="sidebar-link">优化总结</a></li></ul></li><li><a href="/myVuepress/node/node_BFF/bff_three_optimization_cluster.html" class="sidebar-link">性能工具 - cluster与进程守护管理</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>框架和工程化篇</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="性能工具-实际代码优化"><a href="#性能工具-实际代码优化" class="header-anchor">#</a> 性能工具 - 实际代码优化</h1> <h2 id="优化分析"><a href="#优化分析" class="header-anchor">#</a> 优化分析</h2> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
  <span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'/source/index.html'</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>针对我们原来的代码，我们进行<code>localhost:3000/download/</code>进行测试，结果如下</p> <img src="/myVuepress/node_bff_youhua_reasult1.png" alt="分析结果"> <img src="/myVuepress/node_bff_youhua_result2.png" alt="分析结果"> <p>从上面的<code>cpu</code>结果看，我们原有的代码有两个大的问题，</p> <ul><li>第一所有用户进来都要重新读取<code>html</code>文件，因为这里是下载页，无论谁来访问都是这个页面，所以其实我们可以把读取的结果拉到外面去，让它在程序启动的时候就读取出来，每个用户进来只需要拿结果，不需要每个人访问都要重新读取</li> <li>第二就是关于<code>buffer</code>的操作很频繁，我们来思考一下，因为<code>Node</code>底层是<code>C++</code>，所以即使你给<code>http</code>的<code>body</code>赋值了一个字符串，在<code>Node</code>运行的时候还是要转化成为<code>Buffer</code>才能输出出去，因为要转化成为<code>C++</code>认识的结构。所以我们通过文件读取出来的是字符串，字符串还要转化成为<code>buffer</code>，我们直接读取<code>buffer</code>不就完事了，而且<code>fs.readFile</code>读取的本身就是<code>Buffer</code>，所以我们原有的代码就是多此一举。</li></ul> <p>所以我们修改代码如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> buffer <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'/source/index.html'</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
  <span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span>
    ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'html'</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> buffer
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>我们这里做的就是把读取同一个文件的操作拿了出去，然后主动告诉<code>ctx.type</code>的返回类型，因为<code>koa</code>识别到我们返回的是<code>buffer</code>可能会执行下载操作。所以这样优化之后我们的<code>qps</code>还有吞吐量都会上去，因为每个用户不用去执行读取文件的操作，只需要拿结果就好。</p> <h2 id="内存管理优化"><a href="#内存管理优化" class="header-anchor">#</a> 内存管理优化</h2> <p>这里我们先简单介绍一下垃圾回收，因为<code>GC</code>和<code>V8</code>的联系紧密，如果想深度了解垃圾回收和<code>V8</code>的机制，建议到<a href="https://www.taopoppy.cn/node/two_module_v8.html" target="_blank" rel="noopener noreferrer">核心模块 - v8<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>去研究一下。</p> <p><code>js</code>引擎会记录所有我们创建的<code>javascript</code>对象，隔一段时间就会去定时清理没有再被使用的<code>javascript</code>对象。每一个<code>javascript</code>引擎的垃圾回收机制都是不一样的，我们这里就以<code>V8</code>为例，它会把堆内存分为<font color="#DD1144">新生代</font>和<font color="#DD1144">老生代</font>，新创建的<code>javascript</code>变量都会先分配到新生代当中，等新生代快要满的时候就会执行快速的垃圾回收，腾出空间给新的<code>javascript</code>对象使用，如果经过几轮的快速的垃圾回收，有些<code>javascript</code>变量都没有被清理，它就会进入老生代区域，老生代的内存更大，垃圾清理的频率会更低。整个这个过程就是简单的<code>V8</code>垃圾回收机制。</p> <p>那么对我们优化来说有什么作用呢，其实不管新生代还是老生代，都满足一个规律就是：<font color="#1E90FF">放在里面的内存越少，垃圾回收的速度就越快</font>，所以我们要注意减少内存的使用，另外内存泄漏也是关键的地方，<font color="#1E90FF">因为内存一旦泄露，就会长期处于老生代，然后老生代的垃圾回收每次都要遍历这段泄露的大内存，导致垃圾回收的速度减慢。</font>,我们下面来研究一个内存泄漏的情况：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> buffer <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'/source/index.htm'</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
  <span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span>
    ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'html'</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> buffer
    leak<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">const</span> leak <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>上述代码，我们看到用户的每次请求的字符串都被保存在一个<code>leak</code>的数组当中，然后我们来用<code>ab</code>测试一下，采用上一小节的那个内存检测的方法来进行检测，我们快照了程序运行中的内存和程序结束后的内存，然后进行比较</p> <img src="/myVuepress/node_bff_ab_memory.png" alt="内存检测"> <p>可以看到在<code>Profiles</code>当中，快照1是程序运行时的内存检测为208M，而到了程序结束就有1282M,这个显然有内存没有释放,接着看到在整个的<code>Constructor</code>当中，<code>(string)</code>的<code>Size Delta</code>相对于其他特别大，打开一看全是<code>html</code>文件的字符串，点击任意其中一个，看到在<code>Object</code>当中能够看到这些字符串的持有者为<font color="#DD1144">leak</font>,所以你到程序中一看，原来是<code>leak</code>数组没有被释放，这下你就知道内存的问题了</p> <h2 id="多进程优化"><a href="#多进程优化" class="header-anchor">#</a> 多进程优化</h2> <h3 id="_1-node中的进程和线程"><a href="#_1-node中的进程和线程" class="header-anchor">#</a> 1. node中的进程和线程</h3> <p>在进行多进程优化之前，还是要明确一下进程和线程的概念</p> <ul><li><font color="#DD1144">进程</font>（类似于公司）
<ul><li>操作系统挂载运行程序员的单元</li> <li>拥有一些独立的资源，如内存等</li></ul></li> <li><font color="#DD1144">线程</font>（类似于职工）
<ul><li>进行运算调度的单元</li> <li>进程内的线程共享进程内的资源</li></ul></li></ul> <p>在<code>node</code>当中，和进程线程分不开的一个东西叫做事件循环，我们来讲一下两者的关系：</p> <ul><li><font color="#1E90FF">主线程运行v8与javascript</font></li> <li><font color="#1E90FF">多个子线程(libuv提供)通过事件循环被调度</font></li></ul> <p>上述可能理解起来比较生涩，我们可以继续借用公司和员工的例子来理解：<font color="#1E90FF">主线程相当于公司里面的的老板，其他子线程相当于公司职员，js主线程老板通过事件循环给其他线程员工分发任务</font>，但是虽然这样的机制已经很好了，但是保不齐老板的事情依旧很多，而且<font color="#1E90FF">js主线程只有一个线程，也只能用到cpu一个核</font>。所以这种情况还是会造成cpu的浪费，所以<code>node</code>提供了子进程和子线程，让其在别的<code>cpu</code>上也跑一个<code>javascript</code>环境，这种情况就相当于一个集团了。如图所示：
<img src="/myVuepress/node_bff_youhua_process.png" alt="多进程"></p> <h3 id="_2-node中的子进程和子线程"><a href="#_2-node中的子进程和子线程" class="header-anchor">#</a> 2. node中的子进程和子线程</h3> <p>然后我们学习一下子进程的创建和使用：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// index.js</span>
<span class="token keyword">const</span> cp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span>
<span class="token comment">// 创建子进程，以child.js为入口文件</span>
<span class="token keyword">const</span> child_process <span class="token operator">=</span> cp<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'/child.js'</span><span class="token punctuation">)</span>

<span class="token comment">// 父进程给子进程发送消息</span>
child_process<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'haha'</span><span class="token punctuation">)</span>

<span class="token comment">// 父进程监听子进程发来的消息 </span>
child_process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent'</span><span class="token punctuation">,</span>str<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// child.js</span>
<span class="token comment">// 子进程监听父进程发来的消息</span>
process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child'</span><span class="token punctuation">,</span>str<span class="token punctuation">)</span>
	<span class="token comment">// 子进程给父进程发送消息</span>
	process<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'hehe'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>通过这样创建子进程的方式，<code>node</code>可以将一些任务进行分发到别的进程中去计算和实现，避免单个进程任务过多和<code>cpu</code>浪费的现象</p> <p>子进程的概念也在<code>node</code>10版本后面提出来了，当你的程序需要很多的<code>cpu</code>计算，那么<font color="#DD1144">Worker Threads</font>是很有用的，但是实际上<code>node</code>当中的事件循环和非阻塞I/O已经能很好的解决并发问题了，而且子进程已经能够充分使用<code>cpu</code>了，除非你很明确的需要子线程，而不是子进程，那么<code>Worker Threads</code>就派上用场了。</p> <h3 id="_3-cluster模块"><a href="#_3-cluster模块" class="header-anchor">#</a> 3.cluster模块</h3> <p><code>cluster</code>内置模块是<code>Node</code>官方特地为了网络服务而设计的，通过它我们可以快速的创建一个多核能力的网络服务程序。</p> <p>我们在上面已经讲了子进程和父进程之间的通信能力很强大，那么能不能通过这种全面的通信能力来将<code>http</code>服务的能力分发出去？含义如下：
<img src="/myVuepress/node_bff_youhua_cluster.png" alt=""></p> <p>正如上面图中所示，使用<code>cluster</code>内置模块可以很方便的来帮助我们进行多进程的优化，所以我们将在下一小节<a href="https://www.taopoppy.cn/node-BFF/bff_three_optimization_cluster.html" target="_blank" rel="noopener noreferrer">cluster与进程守护管理<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>当中使用<code>cluster</code>来实战一波。</p> <h2 id="优化总结"><a href="#优化总结" class="header-anchor">#</a> 优化总结</h2> <p><font color="#1E90FF"><strong>① 计算</strong></font></p> <ul><li><font color="#DD1144">减少不必要的计算</font> <ul><li>比如前端优化我们会把小图合成大图，减少<code>http</code>页面总请求数量，减少<code>TCP</code>断链，<code>http</code>编解包和图片编解码的消耗</li> <li>空间换时间（重复计算的结果进行缓存，直接使用计算结果）
（<font color="#1E90FF">多以对于这条准则我们需要仔细的在整个http请求的过程中思考这个计算是不是必要，能不能拿到别的地方去计算</font>）</li></ul></li> <li><font color="#DD1144">提前计算</font> <ul><li><font color="#1E90FF">尽量将服务阶段的计算拿到启动阶段，避免在运行中间件中进行计算</font></li></ul></li></ul> <p><font color="#1E90FF"><strong>② 内存</strong></font></p> <ul><li><font color="#DD1144">减少内存的使用</font>
+<font color="#1E90FF"></font></li> <li><font color="#DD1144">必须要检查内存是否存在泄露</font></li></ul> <p><font color="#1E90FF"><strong>③ 进程</strong></font></p> <ul><li><font color="#DD1144">使用cluster模块进行进程优化</font></li></ul> <p><strong>参考资料</strong></p> <ol><li><a href="https://blog.csdn.net/weixin_34417635/article/details/89121296" target="_blank" rel="noopener noreferrer">苏宁Nodejs性能优化实战<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://www.imooc.com/article/292954" target="_blank" rel="noopener noreferrer">打造高性能Node服务器<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.imooc.com/article/34378" target="_blank" rel="noopener noreferrer">记一次Node项目的优化<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://juejin.im/entry/5a56d1db6fb9a01cc1223c6d" target="_blank" rel="noopener noreferrer">(阿里国际UED)唯快不破，让nodejs再快一点<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ol></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/#/edit/master/node/node_BFF/bff_three_optimization_js.md" target="_blank" rel="noopener noreferrer">编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">1/15/2020, 11:33:41 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/myVuepress/node/node_BFF/bff_three_optimization_http.html" class="prev">
        性能工具 - 性能检测
      </a></span> <span class="next"><a href="/myVuepress/node/node_BFF/bff_three_optimization_cluster.html">
        性能工具 - cluster与进程守护管理
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/myVuepress/assets/js/app.9affc5a9.js" defer></script><script src="/myVuepress/assets/js/2.f8270d47.js" defer></script><script src="/myVuepress/assets/js/46.bfec08f7.js" defer></script>
  </body>
</html>
